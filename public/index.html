<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ejemplo de Integración con Qlik-Embed Web Components</title>
    <!-- Incluye la librería embed-web-components -->
    <script src="https://cdn.jsdelivr.net/npm/@qlik/embed-web-components@1/dist/index.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        #qlik-app-container { width: 100%; height: 900px; }
        .mensaje { margin-top: 20px; font-weight: bold; }
        .mensaje.exito { color: green; }
        .mensaje.error { color: red; }
    </style>
</head>
<body>
    <h1>Integración de Qlik Sense con Qlik-Embed Web Components</h1>
    <button onclick="embedQlikApp()">Obtener Token y Cargar App</button>
    <div id="status-message" class="mensaje"></div>
    <!-- Aquí se incrustará la aplicación -->
    <div id="qlik-app-container"></div>

    <script>
        async function fetchImpersonationToken() {
            try {
                const response = await fetch('/api/get-impersonation-token');
                if (!response.ok) {
                    throw new Error('No se pudo obtener el token del servidor.');
                }
                const data = await response.json();
                return data.access_token;
            } catch (error) {
                console.error('Error al obtener el token:', error);
                return null;
            }
        }

        async function embedQlikApp() {
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = 'Obteniendo token...';
            statusMessage.className = 'mensaje';

            const accessToken = await fetchImpersonationToken();

            if (!accessToken) {
                statusMessage.textContent = 'Error: No se pudo obtener el token de acceso.';
                statusMessage.className = 'mensaje error';
                return;
            }

            statusMessage.textContent = 'Token obtenido. Incrustando aplicación...';
            statusMessage.className = 'mensaje exito';

            const appContainer = document.getElementById('qlik-app-container');

            // Aquí se crea y configura el componente web
            const qlikApp = document.createElement('qlik-app');
            qlikApp.setAttribute('host', 'keyruspt.eu.qlikcloud.com');
            qlikApp.setAttribute('app-id', '40de9651-2036-42be-a6e0-86ec38362ad0');
            qlikApp.setAttribute('sheet-id', 'XwLsPUk');
            qlikApp.setAttribute('oauth2-access-token', accessToken);
            qlikApp.setAttribute('web-integration-id', '3w8_BslOS_V8LHD6hVHwsNHaRkK_Mm5s');
            qlikApp.setAttribute('theme', 'horizon');
            qlikApp.setAttribute('mode', 'classic/app'); // Puedes cambiar a 'edit' o 'print'

            appContainer.appendChild(qlikApp);
        }
    </script>
</body>
</html>
