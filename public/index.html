<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ejemplo de Integración con Qlik-Embed</title>
    <script src="https://cdn.qlik-dev.com/qlik-embed.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        #qlik-app-container { width: 100%; height: 900px; }
        .mensaje { margin-top: 20px; font-weight: bold; }
        .mensaje.exito { color: green; }
        .mensaje.error { color: red; }
    </style>
</head>
<body>
    <h1>Integración de Qlik Sense con Qlik-Embed</h1>
    <button onclick="embedQlikApp()">Obtener Token y Cargar App</button>
    <div id="status-message" class="mensaje"></div>
    <div id="qlik-app-container"></div>

    <script>
        async function fetchImpersonationToken() {
            try {
                const response = await fetch('/api/get-impersonation-token');
                if (!response.ok) {
                    throw new Error('No se pudo obtener el token del servidor.');
                }
                const data = await response.json();
                return data.access_token;
            } catch (error) {
                console.error('Error al obtener el token:', error);
                return null;
            }
        }

        async function embedQlikApp() {
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = 'Obteniendo token...';
            statusMessage.className = 'mensaje';

            const accessToken = await fetchImpersonationToken();

            if (!accessToken) {
                statusMessage.textContent = 'Error: No se pudo obtener el token de acceso.';
                statusMessage.className = 'mensaje error';
                return;
            }

            statusMessage.textContent = 'Token obtenido. Incrustando aplicación...';
            statusMessage.className = 'mensaje exito';
            const appContainer = document.getElementById('qlik-app-container');

            const embedConfig = {
                host: 'keyruspt.eu.qlikcloud.com',
                appId: '40de9651-2036-42be-a6e0-86ec38362ad0', // Reemplaza con tu App ID
                sheetId: 'XwLsPUk', // Reemplaza con tu Sheet ID
                embed: appContainer,
                oauth2: { accessToken: accessToken },
                webIntegrationId: 'F5lgGsalXWNob9SEj1n-PuH-l93y9Ojk', // Reemplaza con tu Web Integration ID
                theme: 'horizon'
            };

            const qlikEmbed = new QlikEmbed();
            qlikEmbed.embed(embedConfig);

            qlikEmbed.on('embedded', () => {
                statusMessage.textContent = '¡Aplicación incrustada correctamente!';
            });

            qlikEmbed.on('error', (error) => {
                statusMessage.textContent = `Error al incrustar: ${error.message}`;
                statusMessage.className = 'mensaje error';
            });
        }
    </script>
</body>
</html>